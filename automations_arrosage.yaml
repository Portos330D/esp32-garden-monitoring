###############################################################################
# üåø AUTOMATISATIONS ARROSAGE INTELLIGENT ‚Äî VERSION G√âN√âRIQUE POUR GITHUB
# ---------------------------------------------------------------------------
# Ce fichier regroupe 5 automatisations :
# 1) Arrosage intelligent (PRO)
# 2) S√©curit√© : d√©bit nul / niveau bas / arr√™t manuel
# 3) Arr√™t g√©n√©ral
# 4) Arrosage manuel (volume r√©el)
# 5) S√©curit√© trop-plein cuve
#
# ‚ùó Les utilisateurs doivent adapter leurs entit√©s :
# capteurs
#  - sensor.soil_humidity
#  - sensor.soil_temperature
#  - sensor.air_temperature
#  - sensor.rain_today
#  - sensor.uv_index
#  - sensor.tank_level_percent
#  - sensor.flow_rate
#  - sensor.water_usage_total
#
# actionneurs
#  - switch.irrigation_zone_1
#  - switch.irrigation_zone_2
#  - switch.irrigation_pump
#
# input
#  - input_select.irrigation_mode
#  - input_select.manual_zone
#  - input_number.manual_duration
#  - input_boolean.manual_irrigation
#  - input_boolean.irrigation_stop
#
###############################################################################


###############################################################################
# 1Ô∏è‚É£ ARROSAGE INTELLIGENT ‚Äî MODE PRO
###############################################################################
- id: irrigation_intelligent_pro
  alias: "üí¶ Irrigation intelligente ‚Äì Mode PRO"
  description: >
    Arrosage automatique bas√© sur humidit√© du sol, pluie, temp√©ratures,
    UV, niveau de cuve et mode s√©lectionn√©. Calcul dynamique du volume.

  trigger:
    - platform: sun
      event: sunrise
      offset: "-00:45:00"

  action:
    - variables:
        surface_m2: 20
        soil_humidity: "{{ states('sensor.soil_humidity') | float(0) }}"
        soil_temp: "{{ states('sensor.soil_temperature') | float(0) }}"
        air_temp: "{{ states('sensor.air_temperature') | float(0) }}"
        rain_today: "{{ states('sensor.rain_today') | float(0) }}"
        tank_level: "{{ states('sensor.tank_level_percent') | float(0) }}"
        uv: "{{ states('sensor.uv_index') | float(0) }}"
        mode: "{{ states('input_select.irrigation_mode') }}"

        base_l_m2: |
          {% if mode == 'Off' %}
            0
          {% elif mode == 'Eco' %}
            5
          {% elif mode == 'Normal' %}
            8
          {% elif mode == 'Boost' %}
            12
          {% endif %}

        ajust_humidity: |
          {% if soil_humidity < 25 %}
            1.4
          {% elif soil_humidity < 40 %}
            1.0
          {% elif soil_humidity < 60 %}
            0.6
          {% else %}
            0
          {% endif %}

        ajust_rain: |
          {% if rain_today > 5 %}
            0
          {% elif rain_today > 2 %}
            0.3
          {% else %}
            1
          {% endif %}

        ajust_temp: >
          {% set f = 1 %}
          {% if soil_temp > 30 %}{% set f = f * 1.2 %}{% endif %}
          {% if air_temp > 30 %}{% set f = f * 1.2 %}{% endif %}
          {{ f }}

        ajust_tank: |
          {% if tank_level < 15 %}
            0
          {% elif tank_level < 30 %}
            0.4
          {% elif tank_level < 50 %}
            0.7
          {% elif tank_level > 80 %}
            1.2
          {% else %}
            1
          {% endif %}

        final_l_m2: "{{ base_l_m2 * ajust_humidity * ajust_rain * ajust_temp * ajust_tank }}"
        total_liters: "{{ (final_l_m2 * surface_m2) | round(1) }}"

    # üö´ CONDITIONS INSUFFISANTES
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ total_liters | float(0) <= 0 }}"
          sequence:
            - service: notify.mobile_app
              data:
                message: |
                  üö´ *Arrosage annul√© ‚Äî conditions insuffisantes*
                  Humidit√© : {{ soil_humidity }} %
                  Pluie : {{ rain_today }} mm
                  Cuve : {{ tank_level }} %
                  Temp sol : {{ soil_temp }} ¬∞C
                  Mode : {{ mode }}
            - stop: "Arrosage annul√©"

    # üìä D√âBUT ‚Äî MESURE VOLUME R√âEL
    - variables:
        vol_initial: "{{ states('sensor.water_usage_total') | float(0) }}"

    # üåø ACTIVATION
    - service: switch.turn_on
      target:
        entity_id: switch.irrigation_zone_1

    - service: switch.turn_on
      target:
        entity_id: switch.irrigation_pump

    # boucle ‚Äî arr√™t quand volume atteint
    - repeat:
        while:
          - condition: template
            value_template: >
              {{
                (states('sensor.water_usage_total') | float(0))
                - vol_initial < total_liters
              }}
        sequence:
          - delay: "00:00:10"

          # s√©curit√© d√©bit nul
          - choose:
              - conditions:
                  - condition: numeric_state
                    entity_id: sensor.flow_rate
                    below: 0.1
                sequence:
                  - service: switch.turn_off
                    target:
                      entity_id: switch.irrigation_pump
                  - service: switch.turn_off
                    target:
                      entity_id: switch.irrigation_zone_1
                  - service: notify.mobile_app
                    data:
                      message: "‚ùå Arrosage stopp√© ‚Äî d√©bit nul d√©tect√©"
                  - stop: "D√©bit nul"

    # üì¥ ARR√äT
    - service: switch.turn_off
      target:
        entity_id: switch.irrigation_pump

    - delay: 2

    - service: switch.turn_off
      target:
        entity_id: switch.irrigation_zone_1

    # üìä FIN ‚Äî CALCUL VOLUME
    - variables:
        vol_final: "{{ states('sensor.water_usage_total') | float(0) }}"
        vol_reel: "{{ (vol_final - vol_initial) | round(1) }}"

    - service: notify.mobile_app
      data:
        message: |
          ‚úÖ *Arrosage intelligent termin√© (Mode PRO)*  
          üíß Volume r√©el : {{ vol_reel }} L  
          üéØ Pr√©vu : {{ total_liters }} L  
          üå± Humidit√© : {{ soil_humidity }} %  
          üå¶ Pluie : {{ rain_today }} mm  
          üõ¢ Cuve : {{ tank_level }} %


###############################################################################
# 2Ô∏è‚É£ S√âCURIT√â : D√âBIT NUL / NIVEAU BAS / ARR√äT MANUEL
###############################################################################
- id: irrigation_security
  alias: "üî¥ S√©curit√© Irrigation"
  trigger:
    - platform: numeric_state
      entity_id: sensor.flow_rate
      below: 0.2
      for: "00:00:10"

    - platform: numeric_state
      entity_id: sensor.tank_level_percent
      below: 10

    - platform: state
      entity_id: input_boolean.irrigation_stop
      to: "on"

  action:
    - service: switch.turn_off
      target:
        entity_id:
          - switch.irrigation_pump
          - switch.irrigation_zone_1
          - switch.irrigation_zone_2

    - service: notify.mobile_app
      data:
        message: |
          üî¥ *S√©curit√© Irrigation activ√©e*
          D√©bit : {{ states('sensor.flow_rate') }} L/min
          Niveau : {{ states('sensor.tank_level_percent') }} %
          Tous les actionneurs ont √©t√© stopp√©s.


###############################################################################
# 3Ô∏è‚É£ ARR√äT G√âN√âRAL IRRIGATION
###############################################################################
- id: irrigation_global_stop
  alias: "üõë Arr√™t g√©n√©ral Irrigation"
  trigger:
    - platform: state
      entity_id: input_boolean.irrigation_stop
      to: "on"

  action:
    - service: switch.turn_off
      target:
        entity_id:
          - switch.irrigation_zone_1
          - switch.irrigation_zone_2
          - switch.irrigation_pump

    - delay: "00:00:02"

    - service: notify.mobile_app
      data:
        message: |
          üõë *Arr√™t g√©n√©ral Irrigation activ√©*
          Toutes les vannes et la pompe sont coup√©es.


###############################################################################
# 4Ô∏è‚É£ ARROSAGE MANUEL ‚Äî VOLUME R√âEL
###############################################################################
- id: irrigation_manual
  alias: "üíß Arrosage manuel (volume r√©el)"
  trigger:
    - platform: state
      entity_id: input_boolean.manual_irrigation
      to: "on"

  action:
    - variables:
        zone: "{{ states('input_select.manual_zone') }}"
        duration_sec: "{{ (states('input_number.manual_duration') | float(0) * 60) | int }}"
        vol_initial: "{{ states('sensor.water_usage_total') | float(0) }}"

    # ouverture zone
    - choose:
        - conditions: "{{ zone == 'Zone 1' }}"
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.irrigation_zone_1

        - conditions: "{{ zone == 'Zone 2' }}"
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.irrigation_zone_2

    - service: switch.turn_on
      target:
        entity_id: switch.irrigation_pump

    - delay:
        seconds: "{{ duration_sec }}"

    # arr√™t
    - service: switch.turn_off
      target:
        entity_id: switch.irrigation_pump

    - delay: 1

    - choose:
        - conditions: "{{ zone == 'Zone 1' }}"
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.irrigation_zone_1

        - conditions: "{{ zone == 'Zone 2' }}"
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.irrigation_zone_2

    - variables:
        vol_final: "{{ states('sensor.water_usage_total') | float(0) }}"
        vol_reel: "{{ (vol_final - vol_initial) | round(1) }}"

    - service: notify.mobile_app
      data:
        message: |
          üíß *Arrosage manuel termin√©*
          Zone : {{ zone }}
          Dur√©e : {{ (duration_sec / 60) | round(1) }} min
          Volume r√©el : {{ vol_reel }} L

    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.manual_irrigation


###############################################################################
# 5Ô∏è‚É£ S√âCURIT√â TROP-PLEIN CUVE ‚Äî VIDANGE AUTOMATIQUE
###############################################################################
- id: irrigation_tank_overflow
  alias: "üõ¢Ô∏è S√©curit√© Trop-Plein Cuve"
  trigger:
    - platform: numeric_state
      entity_id: sensor.tank_level_percent
      above: 95

  variables:
    target_liters: 100

  action:
    - variables:
        vol_initial: "{{ states('sensor.water_usage_total') | float(0) }}"

    - service: switch.turn_on
      target:
        entity_id: switch.irrigation_zone_1

    - service: switch.turn_on
      target:
        entity_id: switch.irrigation_pump

    - repeat:
        while:
          - condition: template
            value_template: >
              {{
                (states('sensor.water_usage_total') | float(0))
                - vol_initial < target_liters
              }}
        sequence:
          - delay: "00:00:10"

          - choose:
              - conditions:
                  - condition: numeric_state
                    entity_id: sensor.flow_rate
                    below: 0.1
                sequence:
                  - service: notify.mobile_app
                    data:
                      message: "‚ùå D√©bit nul : arr√™t s√©curit√© (trop-plein)"
                  - service: switch.turn_off
                    target:
                      entity_id:
                        - switch.irrigation_zone_1
                        - switch.irrigation_pump
                  - stop: "D√©bit nul"

    - service: switch.turn_off
      target:
        entity_id:
          - switch.irrigation_zone_1
          - switch.irrigation_pump

    - variables:
        vol_final: "{{ states('sensor.water_usage_total') | float(0) }}"
        vol_reel: "{{ (vol_final - vol_initial) | round(1) }}"

    - service: notify.mobile_app
      data:
        message: |
          üõ¢Ô∏è *Trop-plein cuve √©vacu√©*
          Volume √©vacu√© : {{ vol_reel }} L
          Objectif : {{ target_liters }} L
          Efficacit√© : {{ (vol_reel / target_liters * 100) | round(1) }} %

