#############################################
# üåø ESP32 ‚Äì Capteurs Jardin (Temp, Humidit√©, D√©bit)
# Version g√©n√©rique ‚Äì Adaptable √† toute installation
#############################################

esphome:
  name: capteurs-jardin
  friendly_name: Capteurs Jardin

esp32:
  board: esp32dev
  framework:
    type: esp-idf

# -----------------------------
# üì° Connexion Wi-Fi + API
# -----------------------------
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none

api:

ota:

logger:
  level: DEBUG

web_server:
  port: 80

# -----------------------------
# üîå Switch pour activer/d√©sactiver le Bluetooth
# -----------------------------
switch:
  - platform: template
    name: "Bluetooth ESP32 Jardin"
    id: bt_switch
    restore_mode: ALWAYS_OFF
    optimistic: true
    turn_on_action:
      - esp32_ble_tracker.start_scan:
    turn_off_action:
      - esp32_ble_tracker.stop_scan:

# Bluetooth d√©sactiv√© par d√©faut pour √©conomiser des ressources
esp32_ble_tracker:
  scan_parameters:
    duration: 300s
    active: true


# ==========================================================
# üå°Ô∏è 1. SONDES DE TEMP√âRATURE (DS18B20)
# ==========================================================
one_wire:
  - pin: GPIO4

dallas_temp:
  update_interval: 60s

sensor:
  # --------------------------
  # Temp√©rature Ext√©rieure
  # --------------------------
  - platform: dallas_temp
    name: "Temp√©rature Ext√©rieure"
    address: 0x020000006ee80c28
    accuracy_decimals: 1

  # --------------------------
  # Temp√©rature Sol
  # --------------------------
  - platform: dallas_temp
    name: "Temp√©rature Sol"
    address: 0xa922a1bf0a646128
    accuracy_decimals: 1

  # --------------------------
  # Temp√©rature Eau Cuve
  # --------------------------
  - platform: dallas_temp
    name: "Temp√©rature Eau Cuve"
    address: 0x8397be691f64ff28
    accuracy_decimals: 1


# ==========================================================
# üå± 2. HUMIDIT√â DU SOL (ADC)
# ==========================================================
# ‚ö†Ô∏è Calibration √† adapter selon votre installation :
# - Mesurer tension sol sec ‚Üí tension_sec
# - Mesurer tension sol 100% humide ‚Üí tension_humide
# - Formule utilis√©e :
#   (v - tension_humide) * 100 / (tension_sec - tension_humide)
# Exemple g√©n√©rique : tension_sec = 3.3V, tension_humide = 0V
# ==========================================================

  - platform: adc
    pin: GPIO34
    name: "Humidit√© du sol brut"
    id: humidite_brut
    update_interval: 10s
    attenuation: 12db

  - platform: template
    name: "Humidit√© du sol (%)"
    id: humidite_sol
    unit_of_measurement: "%"
    accuracy_decimals: 0
    update_interval: 10s
    lambda: |-
      float v = id(humidite_brut).state;

      // Valeurs par d√©faut (√† adapter) :
      float tension_sec = 3.30;
      float tension_humide = 0.00;

      if (v <= tension_humide) return 100.0;
      if (v >= tension_sec) return 0.0;

      return (v - tension_humide) * 100.0 / (tension_sec - tension_humide);


# ==========================================================
# üíß 3. D√âBITM√àTRE (Pulse Meter)
# ==========================================================
# G√©n√©rique : entr√©e pulse ‚Üí L/min + volume total
# Calibration :
#  pulses_par_litre = pulses_mesur√©s / litres r√©els
# ==========================================================

  - platform: pulse_meter
    pin:
      number: GPIO27
      mode: INPUT_PULLUP
    name: "D√©bitm√®tre Jardin (pulses/min)"
    id: pulse_jardin
    internal_filter: 100us
    timeout: 5s
    accuracy_decimals: 0
    total:
      name: "Volume Jardin Total brut"
      id: pulse_jardin_total
      unit_of_measurement: "pulses"
      accuracy_decimals: 0

  # Nombre de pulses par litre ‚Üí r√©glable via Home Assistant
number:
  - platform: template
    name: "Impulsions/Litre Jardin"
    id: ppl_jardin
    optimistic: true
    restore_value: true
    min_value: 200
    max_value: 1200
    step: 1
    unit_of_measurement: "pulses/L"
    initial_value: 300  # valeur g√©n√©rique


# -----------------------------
# D√©bit L/min (moyenn√© pour √©viter les sauts)
# -----------------------------
  - platform: template
    name: "D√©bit Jardin"
    id: debit_jardin
    unit_of_measurement: "L/min"
    accuracy_decimals: 2
    update_interval: 3s
    filters:
      - sliding_window_moving_average:
          window_size: 3
          send_every: 1
    lambda: |-
      if (id(pulse_jardin).state == 0 || id(ppl_jardin).state == 0) return 0.0;
      return id(pulse_jardin).state / id(ppl_jardin).state;

# -----------------------------
# Volume total converti en litres
# -----------------------------
  - platform: template
    name: "Volume Jardin Total (L)"
    id: volume_jardin
    unit_of_measurement: "L"
    accuracy_decimals: 2
    update_interval: 60s
    lambda: |-
      if (id(ppl_jardin).state == 0) return 0.0;
      return id(pulse_jardin_total).state / id(ppl_jardin).state;


# ==========================================================
# üîÅ Bouton Reset volume total
# ==========================================================
button:
  - platform: template
    name: "üîÅ Reset Volume D√©bitm√®tre"
    on_press:
      - lambda: |-
          id(pulse_jardin_total).publish_state(0);

